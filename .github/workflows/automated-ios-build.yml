name: Automated iOS Build

on:
  push:
    branches:
      - "main"
      - "fix/*"
    tags:
      - "build-ci*"
  pull_request:
    branches:
      - "main"
  workflow_dispatch:
    inputs:
      upload_release:
        description: 'Upload to CI release'
        required: false
        default: 'true'
        type: boolean

jobs:
  # Unsigned build for AltStore
  build-unsigned:
    runs-on: macos-26
    steps:
    - uses: actions/checkout@v3
    
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'
    
    - name: Build unsigned .app
      run: |
        xcodebuild \
          -project qBitControl.xcodeproj \
          -scheme qBitControl \
          -configuration Release \
          -derivedDataPath build \
          -destination 'generic/platform=iOS' \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          clean build
    
    - name: Create .ipa for AltStore
      run: |
        # Find the .app bundle
        APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" -type d | head -1)
        echo "Found app at: $APP_PATH"
        
        # Create .ipa structure
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        
        # Create .ipa (zip with .ipa extension)
        zip -r qBitControl-unsigned.ipa Payload
        
        # Get version info
        INFO_PLIST="$APP_PATH/Info.plist"
        VERSION=$(plutil -extract CFBundleShortVersionString raw "$INFO_PLIST" 2>/dev/null || echo "1.0")
        BUILD_NUM=$(plutil -extract CFBundleVersion raw "$INFO_PLIST" 2>/dev/null || echo "1")
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_ENV
        
        echo "Created qBitControl-unsigned.ipa"
        ls -la qBitControl-unsigned.ipa
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: qBitControl-unsigned
        path: qBitControl-unsigned.ipa
        retention-days: 30
    
    - name: Create CI Release
      if: inputs.upload_release == 'true' || startsWith(github.ref, 'refs/tags/build-ci')
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        prerelease: true
        automatic_release_tag: "CI"
        title: "qBitControl ${{ env.VERSION }} (${{ env.BUILD_NUM }}) - AltStore"
        files: |
          qBitControl-unsigned.ipa

  # Signed build (requires secrets)
  build-signed:
    if: ${{ secrets.P12_BASE64 != '' }}
    runs-on: macos-26
    steps:
    - uses: actions/checkout@v3
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'
    - uses: yukiarrr/ios-build-action@v1.11.2
      with:
        project-path: qBitControl.xcodeproj
        p12-base64: ${{ secrets.P12_BASE64 }}
        mobileprovision-base64: ${{ secrets.MOBILEPROVISION_BASE64 }}
        code-signing-identity: ${{ secrets.CODE_SIGNING_IDENTITY }}
        team-id: ${{ secrets.TEAM_ID }}
        output-path: qBitControl-signed.ipa
    - name: Upload signed artifact
      uses: actions/upload-artifact@v4
      with:
        name: qBitControl-signed
        path: qBitControl-signed.ipa
        retention-days: 30
